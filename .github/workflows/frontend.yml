# =============================================================================
# PIPELINE: Frontend Angular - Solutions Delivery
# =============================================================================
# Este workflow se ejecuta cuando hay cambios en la carpeta solutions_front/
#
# FLUJO:
#   1. Lint      - Verificar calidad de código con ESLint
#   2. Test      - Ejecutar pruebas unitarias con Karma
#   3. Build     - Compilar Angular para producción
#   4. Deploy    - Subir a S3 (dev o prod según la rama)
#
# ENVIRONMENTS (GitHub Environments):
#   - dev:        Se usa cuando push a develop
#   - production: Se usa cuando push a main
#
# SECRETS POR ENVIRONMENT:
#   Cada environment debe tener configurados estos secrets en GitHub:
#   - AWS_ACCESS_KEY_ID
#   - AWS_SECRET_ACCESS_KEY
#   - AWS_REGION
#   - S3_BUCKET_NAME (ej: solutions-frontend-dev o solutions-frontend-prod)
#   - CLOUDFRONT_DISTRIBUTION_ID (solo en production, opcional)
# =============================================================================

name: Frontend CI/CD

on:
    # ==========================================================================
    # TRIGGER 1: Push a main o develop
    # ==========================================================================
    # Solo se ejecuta si hay cambios en solutions_front/ o en este archivo
    # Esto evita ejecutar el pipeline cuando solo cambias el backend
    # ==========================================================================
    push:
        branches:
            - main
            - develop
        paths:
            - "solutions_front/**"
            - ".github/workflows/frontend.yml"

    # ==========================================================================
    # TRIGGER 2: Pull Request a main
    # ==========================================================================
    # Ejecuta lint, test y build para validar el PR
    # NO hace deploy (los PRs no deben deployar)
    # ==========================================================================
    pull_request:
        branches:
            - main
        paths:
            - "solutions_front/**"

    # ==========================================================================
    # TRIGGER 3: Ejecución manual desde GitHub UI
    # ==========================================================================
    # Ve a Actions > Frontend CI/CD > Run workflow
    # Puedes elegir el environment (dev/prod)
    # ==========================================================================
    workflow_dispatch:
        inputs:
            environment:
                description: "Entorno de deploy"
                required: true
                default: "dev"
                type: choice
                options:
                    - dev
                    - prod

# =============================================================================
# CONCURRENCY: Evitar ejecuciones duplicadas
# =============================================================================
# Si haces 3 commits seguidos a develop, cancela los 2 primeros
# y solo ejecuta el último. Ahorra tiempo y dinero.
# =============================================================================
concurrency:
    group: frontend-${{ github.ref }}
    cancel-in-progress: true

# =============================================================================
# VARIABLES DE ENTORNO GLOBALES
# =============================================================================
env:
    NODE_VERSION: "20"
    WORKING_DIRECTORY: "solutions_front"

# =============================================================================
# JOBS
# =============================================================================
jobs:
    # =========================================================================
    # JOB 1: LINT
    # =========================================================================
    # Verifica la calidad del código con ESLint
    # Si hay errores de lint, el pipeline falla aquí y no continúa
    # =========================================================================
    lint:
        name: Lint
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIRECTORY }}

        steps:
            - name: Checkout codigo
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

            - name: Instalar dependencias
              run: npm ci

            - name: Validar variables de entorno
              run: |
                  if [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    npm run validate:env:prod
                  else
                    npm run validate:env
                  fi

            - name: Ejecutar ESLint
              run: npm run lint

    # =========================================================================
    # JOB 2: TEST
    # =========================================================================
    # Ejecuta las pruebas unitarias con Karma
    # needs: lint = espera a que LINT termine exitosamente
    # =========================================================================
    test:
        name: Test
        runs-on: ubuntu-latest
        needs: lint
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIRECTORY }}

        steps:
            - name: Checkout codigo
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

            - name: Instalar dependencias
              run: npm ci

            - name: Ejecutar tests unitarios
              run: npm run test:ci

            - name: Subir reporte de coverage
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report
                  path: ${{ env.WORKING_DIRECTORY }}/coverage/
                  retention-days: 7

    # =========================================================================
    # JOB 3: BUILD
    # =========================================================================
    # Compila Angular para producción
    # El artefacto se guarda para usarlo en los jobs de deploy
    # =========================================================================
    build:
        name: Build
        runs-on: ubuntu-latest
        needs: test
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIRECTORY }}

        steps:
            - name: Checkout codigo
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ env.NODE_VERSION }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

            - name: Instalar dependencias
              run: npm ci

            - name: Build de produccion
              run: npm run build -- --configuration=production

            - name: Subir artefacto de build
              uses: actions/upload-artifact@v4
              with:
                  name: frontend-dist
                  path: ${{ env.WORKING_DIRECTORY }}/dist/
                  retention-days: 7

    # =========================================================================
    # JOB 4: DEPLOY DEV
    # =========================================================================
    # Se ejecuta cuando:
    #   - Push a develop
    #   - O workflow_dispatch con environment = dev
    #
    # Usa el GitHub Environment "dev" que tiene sus propios secrets:
    #   - S3_BUCKET_NAME = solutions-frontend-dev
    #   - AWS credentials de la cuenta de dev
    # =========================================================================
    deploy-dev:
        name: Deploy to DEV
        runs-on: ubuntu-latest
        needs: build
        if: |
            (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
            (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
        environment: dev

        steps:
            - name: Descargar artefacto de build
              uses: actions/download-artifact@v4
              with:
                  name: frontend-dist
                  path: dist/

            - name: Configurar AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Sync a S3
              run: |
                  echo "Deploying to DEV: ${{ secrets.S3_BUCKET_NAME }}"

                  # Assets con cache de 1 año (tienen hash en el nombre)
                  aws s3 sync dist/solutions_front/browser s3://${{ secrets.S3_BUCKET_NAME }} \
                    --delete \
                    --cache-control "public, max-age=31536000" \
                    --exclude "index.html" \
                    --exclude "*.json"

                  # index.html sin cache para actualizaciones inmediatas
                  aws s3 cp dist/solutions_front/browser/index.html \
                    s3://${{ secrets.S3_BUCKET_NAME }}/index.html \
                    --cache-control "no-cache, no-store, must-revalidate"

                  echo "Deploy to DEV completed!"

    # =========================================================================
    # JOB 5: DEPLOY PRODUCTION
    # =========================================================================
    # Se ejecuta cuando:
    #   - Push a main
    #   - O workflow_dispatch con environment = prod
    #
    # Usa el GitHub Environment "production" que tiene sus propios secrets:
    #   - S3_BUCKET_NAME = solutions-frontend-prod
    #   - CLOUDFRONT_DISTRIBUTION_ID (para invalidar cache)
    #   - AWS credentials de la cuenta de prod
    #
    # NOTA: Puedes configurar "Required reviewers" en el environment
    # para que alguien apruebe antes de deployar a producción
    # =========================================================================
    deploy-prod:
        name: Deploy to PRODUCTION
        runs-on: ubuntu-latest
        needs: build
        if: |
            (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
            (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
        environment: production

        steps:
            - name: Descargar artefacto de build
              uses: actions/download-artifact@v4
              with:
                  name: frontend-dist
                  path: dist/

            - name: Configurar AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Sync a S3
              run: |
                  echo "Deploying to PRODUCTION: ${{ secrets.S3_BUCKET_NAME }}"

                  # Assets con cache de 1 año
                  aws s3 sync dist/solutions_front/browser s3://${{ secrets.S3_BUCKET_NAME }} \
                    --delete \
                    --cache-control "public, max-age=31536000" \
                    --exclude "index.html" \
                    --exclude "*.json"

                  # index.html sin cache
                  aws s3 cp dist/solutions_front/browser/index.html \
                    s3://${{ secrets.S3_BUCKET_NAME }}/index.html \
                    --cache-control "no-cache, no-store, must-revalidate"

                  echo "Deploy to PRODUCTION completed!"

            # Descomentar cuando tengas CloudFront configurado
            # - name: Invalidar CloudFront cache
            #   run: |
            #       aws cloudfront create-invalidation \
            #         --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            #         --paths "/*"

<!-- Stepper -->
<div class="stepper">
  <div class="stepper-track">
    <div class="stepper-progress" [style.width]="(currentStepIndex / 2 * 100) + '%'"></div>
  </div>
  <div class="stepper-steps">
    <div
      *ngFor="let step of steps; let i = index"
      class="stepper-step"
      [class.active]="i === currentStepIndex"
      [class.completed]="i < currentStepIndex">
      <div class="step-circle">
        <span *ngIf="i >= currentStepIndex">{{ i + 1 }}</span>
        <span *ngIf="i < currentStepIndex" class="step-check">&#10003;</span>
      </div>
      <span class="step-label">{{ step.label }}</span>
    </div>
  </div>
</div>

<!-- Step 1: Email -->
<form *ngIf="forgotStep === 'email'" (ngSubmit)="handleSendCode($event)" class="form step-form">
  <div class="step-header">
    <div class="step-icon">
      <app-icon category="actions" name="lock" size="28px"></app-icon>
    </div>
    <p class="step-description">Ingresa tu correo electrónico y te enviaremos un código de verificación.</p>
  </div>

  <div class="form-group">
    <label for="forgot-email">Correo electrónico</label>
    <input
      id="forgot-email"
      type="email"
      [(ngModel)]="forgotEmail"
      name="forgotEmail"
      required
      [disabled]="isLoading"
      [class.input-error]="forgotEmailError"
      autocomplete="email"
      placeholder="usuario@ejemplo.com"
    />
    <span *ngIf="forgotEmailError" class="error-message">{{ forgotEmailError }}</span>
  </div>

  <button type="submit" class="btn btn-primary" [disabled]="isLoading">
    <span *ngIf="!isLoading">Enviar código de recuperación</span>
    <span *ngIf="isLoading" class="loading-content">
      <span class="spinner"></span>
      Enviando código...
    </span>
  </button>

  <p class="form-footer">
    <button
      type="button"
      (click)="onSwitchToLogin()"
      class="link-button"
      [disabled]="isLoading">
      Volver al inicio de sesión
    </button>
  </p>
</form>

<!-- Step 2: Code -->
<form *ngIf="forgotStep === 'code'" (ngSubmit)="handleVerifyCode($event)" class="form step-form">
  <div class="step-header">
    <div class="info-box">
      <app-icon category="communication" name="mail" size="20px"></app-icon>
      <p>Código enviado a: <strong>{{ forgotEmail }}</strong></p>
    </div>
  </div>

  <div class="form-group">
    <label id="code-label">Código de verificación</label>
    <div class="code-inputs" aria-labelledby="code-label" role="group" (paste)="onCodePaste($event)">
      <input
        *ngFor="let digit of codeDigits; let i = index"
        #codeInput
        type="text"
        inputmode="numeric"
        maxlength="1"
        class="code-digit"
        [value]="codeDigits[i]"
        [disabled]="isLoading"
        [class.input-error]="forgotCodeError"
        (input)="onCodeInput($event, i)"
        (keydown)="onCodeKeydown($event, i)"
      />
    </div>
    <span *ngIf="forgotCodeError" class="error-message code-error">{{ forgotCodeError }}</span>
  </div>

  <button type="submit" class="btn btn-primary" [disabled]="isLoading || codeString.length !== 6">
    <span>Verificar código</span>
  </button>

  <div class="resend-section">
    <p>¿No recibiste el código?</p>
    <button
      type="button"
      (click)="handleResendCode()"
      class="btn-link"
      [disabled]="resendCountdown > 0 || isLoading">
      <span *ngIf="resendCountdown > 0">Reenviar código ({{ resendCountdown }}s)</span>
      <span *ngIf="resendCountdown === 0 && !isLoading">Reenviar código</span>
      <span *ngIf="isLoading" class="loading-content">
        <span class="spinner-small"></span>
        Reenviando...
      </span>
    </button>
  </div>

  <div class="step-navigation">
    <button type="button" (click)="goBackStep()" class="link-button" [disabled]="isLoading">
      &#8592; Volver
    </button>
    <button type="button" (click)="onSwitchToLogin()" class="link-button" [disabled]="isLoading">
      Cancelar
    </button>
  </div>
</form>

<!-- Step 3: New Password -->
<form *ngIf="forgotStep === 'password'" (ngSubmit)="handleSetPassword($event)" class="form step-form">
  <div class="step-header">
    <div class="step-icon">
      <app-icon category="actions" name="lock" size="28px"></app-icon>
    </div>
    <p class="step-description">Crea una nueva contraseña segura para tu cuenta.</p>
  </div>

  <div class="form-group">
    <label for="forgot-new-password">Nueva contraseña</label>
    <div class="password-input-wrapper">
      <input
        id="forgot-new-password"
        [type]="showNewPassword ? 'text' : 'password'"
        [(ngModel)]="forgotNewPassword"
        name="forgotNewPassword"
        required
        [disabled]="isLoading"
        [class.input-error]="forgotNewPasswordError"
        autocomplete="new-password"
        placeholder="••••••••"
      />
      <button
        type="button"
        class="password-toggle"
        (click)="toggleNewPasswordVisibility()"
        tabindex="-1">
        <app-icon
          category="navigation"
          [name]="showNewPassword ? 'x' : 'eye'"
          size="20px">
        </app-icon>
      </button>
    </div>
    <span *ngIf="forgotNewPasswordError" class="error-message">{{ forgotNewPasswordError }}</span>

    <!-- Password strength indicator -->
    <div *ngIf="forgotNewPassword" class="password-strength">
      <div class="strength-bar">
        <div
          class="strength-fill"
          [class]="passwordStrength.color"
          [style.width]="(passwordStrength.level / 5 * 100) + '%'">
        </div>
      </div>
      <span class="strength-label" [class]="passwordStrength.color">{{ passwordStrength.label }}</span>
    </div>

    <small class="input-hint">Mínimo 8 caracteres, incluye mayúsculas, minúsculas, números y caracteres especiales</small>
  </div>

  <div class="form-group">
    <label for="forgot-confirm-password">Confirmar contraseña</label>
    <div class="password-input-wrapper">
      <input
        id="forgot-confirm-password"
        [type]="showConfirmPassword ? 'text' : 'password'"
        [(ngModel)]="forgotConfirmPassword"
        name="forgotConfirmPassword"
        required
        [disabled]="isLoading"
        [class.input-error]="forgotConfirmPasswordError"
        autocomplete="new-password"
        placeholder="••••••••"
      />
      <button
        type="button"
        class="password-toggle"
        (click)="toggleConfirmPasswordVisibility()"
        tabindex="-1">
        <app-icon
          category="navigation"
          [name]="showConfirmPassword ? 'x' : 'eye'"
          size="20px">
        </app-icon>
      </button>
    </div>
    <span *ngIf="forgotConfirmPasswordError" class="error-message">{{ forgotConfirmPasswordError }}</span>
  </div>

  <button type="submit" class="btn btn-primary" [disabled]="isLoading">
    <span *ngIf="!isLoading">Cambiar Contraseña</span>
    <span *ngIf="isLoading" class="loading-content">
      <span class="spinner"></span>
      Cambiando contraseña...
    </span>
  </button>

  <div class="step-navigation">
    <button type="button" (click)="goBackStep()" class="link-button" [disabled]="isLoading">
      &#8592; Volver
    </button>
    <button type="button" (click)="onSwitchToLogin()" class="link-button" [disabled]="isLoading">
      Cancelar
    </button>
  </div>
</form>

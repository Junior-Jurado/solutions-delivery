<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <div class="logo-container">
          <div class="logo-circle">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.29 7 12 12 20.71 7"></polyline>
              <line x1="12" y1="22" x2="12" y2="12"></line>
            </svg>
          </div>
          <span class="logo-text">EnvíoExpress</span>
        </div>
      </div>
      
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="user-details">
            <div class="user-role">Secretari@</div>
            <div class="user-description">Panel de gestión</div>
          </div>
        </div>
        <button class="btn-logout" (click)="handleLogout()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span class="logout-text">Cerrar Sesión</span>
        </button>
      </div>
    </div>
  </header>

  <div class="secretary-panel">
    <!-- Tabs Navigation -->
    <div class="tabs-navigation">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'create-guide'"
        (click)="setActiveTab('create-guide')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <span>Nueva Guía</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'manage-guides'"
        (click)="setActiveTab('manage-guides')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span>Gestionar Guías</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'search'"
        (click)="setActiveTab('search')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span>Buscar/Rastrear</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'reports'"
        (click)="setActiveTab('reports')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
        <span>Reportes</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'cash-close'"
        (click)="setActiveTab('cash-close')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="5" width="20" height="14" rx="2"></rect>
          <line x1="2" y1="10" x2="22" y2="10"></line>
        </svg>
        <span>Cierre de Caja</span>
      </button>
    </div>

    <!-- Create Guide Tab -->
    <div class="tab-content" *ngIf="activeTab === 'create-guide'">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 16h6"></path>
              <path d="M16 8h6"></path>
              <path d="M16 12h6"></path>
              <rect x="2" y="6" width="12" height="12" rx="2"></rect>
            </svg>
            Nueva Guía de Envío
          </h2>
          <p class="card-description">Crear una nueva guía para envío de paquetes</p>
        </div>
        <div class="card-content">
          <form [formGroup]="guideForm" (ngSubmit)="handleCreateGuide()" class="guide-form">
            <div class="form-grid">
              <!-- Remitente -->
              <div class="form-section">
                <div class="section-header">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                  <h3>Información del Remitente</h3>
                </div>

                <div class="form-row">
                  <div class="form-field">
                    <label for="senderName">Nombre completo *</label>
                    <input id="senderName" type="text" formControlName="senderName" placeholder="Juan Pérez">
                    <span class="error-message" *ngIf="hasError('senderName')">
                      {{ getErrorMessage('senderName') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="senderDocType">Tipo de documento *</label>
                    <select id="senderDocType" formControlName="senderDocType">
                      <option *ngFor="let type of documentTypes" [value]="type">{{type}}</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-field">
                    <label for="senderDoc">Número de documento *</label>
                    <input id="senderDoc" type="text" formControlName="senderDoc" placeholder="12345678">
                    <span class="error-message" *ngIf="hasError('senderDoc')">
                      {{ getErrorMessage('senderDoc') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="senderPhone">Teléfono *</label>
                    <input id="senderPhone" type="tel" formControlName="senderPhone" placeholder="3001234567">
                    <span class="error-message" *ngIf="hasError('senderPhone')">
                      {{ getErrorMessage('senderPhone') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="senderEmail">Email</label>
                    <input id="senderEmail" type="email" formControlName="senderEmail" placeholder="juan@email.com">
                  </div>
                </div>

                <div class="form-field">
                  <label for="senderAddress">Dirección completa *</label>
                  <textarea id="senderAddress" formControlName="senderAddress" 
                    placeholder="Calle 123 #45-67, Barrio"></textarea>
                  <span class="error-message" *ngIf="hasError('senderAddress')">
                    {{ getErrorMessage('senderAddress') }}
                  </span>
                </div>
                <div class="form-field">
                  <label for="senderCity">Ciudad origen *</label>
                  <app-city-selector
                    formControlName="senderCity"
                    [enableSearch]="true"
                    placeholder="Buscar ciudad de origen..."
                    (citySelected)="onSenderCitySelected($event)">
                  </app-city-selector>
                  <span class="error-message" *ngIf="hasError('senderCity')">
                    {{ getErrorMessage('senderCity') }}
                  </span>
                </div>  
              </div>

              <!-- Destinatario -->
              <div class="form-section">
                <div class="section-header destination">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  <h3>Información del Destinatario</h3>
                </div>

                <div class="form-row">
                  <div class="form-field">
                    <label for="receiverName">Nombre completo *</label>
                    <input id="receiverName" type="text" formControlName="receiverName" placeholder="María González">
                    <span class="error-message" *ngIf="hasError('receiverName')">
                      {{ getErrorMessage('receiverName') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="receiverDocType">Tipo de documento *</label>
                    <select id="receiverDocType" formControlName="receiverDocType">
                      <option *ngFor="let type of documentTypes" [value]="type">{{type}}</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-field">
                    <label for="receiverDoc">Número de documento *</label>
                    <input id="receiverDoc" type="text" formControlName="receiverDoc" placeholder="87654321">
                    <span class="error-message" *ngIf="hasError('receiverDoc')">
                      {{ getErrorMessage('receiverDoc') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="receiverPhone">Teléfono *</label>
                    <input id="receiverPhone" type="tel" formControlName="receiverPhone" placeholder="3009876543">
                    <span class="error-message" *ngIf="hasError('receiverPhone')">
                      {{ getErrorMessage('receiverPhone') }}
                    </span>
                  </div>
                  <div class="form-field">
                    <label for="receiverEmail">Email</label>
                    <input id="receiverEmail" type="email" formControlName="receiverEmail" placeholder="maria@email.com">
                  </div>
                </div>

                <div class="form-field">
                  <label for="receiverAddress">Dirección completa *</label>
                  <textarea id="receiverAddress" formControlName="receiverAddress" 
                    placeholder="Carrera 89 #12-34, Barrio"></textarea>
                  <span class="error-message" *ngIf="hasError('receiverAddress')">
                    {{ getErrorMessage('receiverAddress') }}
                  </span>
                </div>
                <div class="form-field">
                  <label for="receiverCity">Ciudad destino *</label>
                  <app-city-selector
                    formControlName="receiverCity"
                    [enableSearch]="true"
                    placeholder="Buscar ciudad de destino..."
                    (citySelected)="onReceiverCitySelected($event)">
                  </app-city-selector>
                  <span class="error-message" *ngIf="hasError('receiverCity')">
                    {{ getErrorMessage('receiverCity') }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Información del Paquete -->
            <div class="form-section full-width">
              <div class="section-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                  <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <h3>Información del Paquete</h3>
              </div>
              <div class="form-row four-cols">
                <div class="form-field">
                  <label for="serviceType">Tipo de servicio *</label>
                  <select id="serviceType" formControlName="serviceType">
                    <option value="">Seleccionar</option>
                    <option *ngFor="let type of serviceTypes" [value]="type">{{type}}</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="weight">Peso (kg) *</label>
                  <input id="weight" type="number" step="0.1" formControlName="weight" placeholder="1.5">
                </div>
                <div class="form-field">
                  <label for="declaredValue">Valor declarado *</label>
                  <input id="declaredValue" type="text" formControlName="declaredValue" placeholder="50000">
                </div>
                <div class="form-field">
                  <label for="pieces">Número de piezas</label>
                  <input id="pieces" type="number" formControlName="pieces">
                </div>
              </div>
              <div class="form-row three-cols">
                <div class="form-field">
                  <label for="dimensions">Dimensiones (cm)</label>
                  <input id="dimensions" type="text" formControlName="dimensions" placeholder="20x15x10">
                </div>
                <div class="form-field">
                  <label for="priority">Prioridad</label>
                  <select id="priority" formControlName="priority">
                    <option *ngFor="let priority of priorities" [value]="priority.toLowerCase()">{{priority}}</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="insurance">Seguro adicional</label>
                  <select id="insurance" formControlName="insurance">
                    <option *ngFor="let option of insuranceOptions" [value]="option.toLowerCase()">{{option}}</option>
                  </select>
                </div>
              </div>
              <div class="form-field">
                <label for="content">Descripción del contenido</label>
                <textarea id="content" formControlName="content" 
                  placeholder="Descripción detallada del contenido del paquete"></textarea>
              </div>
              <div class="form-field">
                <label for="observations">Observaciones especiales</label>
                <textarea id="observations" formControlName="observations" 
                  placeholder="Instrucciones especiales para la entrega"></textarea>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-large" [disabled]="!guideForm.valid || isSubmitting">
              <svg *ngIf="isSubmitting" class="spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
              </svg>
              {{ isSubmitting ? 'Creando guía...' : 'Crear Guía de Envío' }}
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Manage Guides Tab -->
    <div class="tab-content" *ngIf="activeTab === 'manage-guides'">
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">Filtros de Búsqueda</h2>
        </div>
        <div class="card-content">
          <div class="filters-grid">
            <select [(ngModel)]="selectedStatusFilter">
              <option value="">Estado - Todos</option>
              <option *ngFor="let status of availableStatuses" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
            <select [(ngModel)]="selectedCityFilter">
              <option value="">Ciudad - Todas</option>
              <option *ngFor="let city of filterCities" [value]="city.id">
                {{ city.name }}, {{ city.department_name }}
              </option>
            </select>
            
            <!-- Input de fecha con formato dd/mm/yyyy -->
            <div class="date-input-wrapper">
              <input 
                type="text" 
                [value]="displayDateFrom"
                (input)="onDateFromChange($event)"
                placeholder="Desde: dd/mm/aaaa"
                maxlength="10"
                class="date-input">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="date-icon">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            
            <div class="date-input-wrapper">
              <input 
                type="text" 
                [value]="displayDateTo"
                (input)="onDateToChange($event)"
                placeholder="Hasta: dd/mm/aaaa"
                maxlength="10"
                class="date-input">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="date-icon">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <button class="btn btn-primary" (click)="applyFilters()">Filtrar</button>
            <button class="btn btn-outline" (click)="clearFilters()">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Gestión de Guías</h2>
          <p class="card-description">
            Mostrando {{ guides.length }} de {{ totalGuides }} guías
          </p>
        </div>
        <div class="card-content">
          <!-- Loading State -->
          <div *ngIf="isLoadingGuides" class="loading-container">
            <div class="spinner"></div>
            <p>Cargando guías...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoadingGuides && guides.length === 0" class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            <h3>No se encontraron guías</h3>
            <p>No hay guías que coincidan con los filtros seleccionados</p>
          </div>

          <!-- Guides List -->
          <div *ngIf="!isLoadingGuides && guides.length > 0" class="guides-list">
            <div *ngFor="let guide of guides" class="guide-item">
              <div class="guide-header">
                <div>
                  <div class="guide-id">Guía #{{ guide.guide_id }}</div>
                  <div class="guide-date">{{ formatDate(guide.created_at) }}</div>
                </div>
                <span class="badge" [ngClass]="getStatusBadgeClass(guide.current_status)">
                  {{ translateStatus(guide.current_status) }}
                </span>
              </div>
              
              <div class="guide-details">
                <div class="detail-item">
                  <div class="detail-label">Origen:</div>
                  <div class="detail-value">{{ guide.origin_city_name }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Destino:</div>
                  <div class="detail-value">{{ guide.destination_city_name }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Tipo de servicio:</div>
                  <div class="detail-value">{{ translateServiceType(guide.service_type) }}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Método de pago:</div>
                    <div class="detail-value">{{ translatePaymentMethod(guide.payment_method) }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Valor:</div>
                  <div class="detail-value">${{ guide.price.toLocaleString() }}</div>
                </div>
              </div>
              
              <div class="guide-actions">
                <select 
                  class="status-select" 
                  [value]="guide.current_status"
                  (change)="handleUpdateStatus(guide.guide_id, $any($event.target).value)">
                  <option value="">Cambiar estado</option>
                  <option *ngFor="let status of availableStatuses" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
                <button class="btn btn-outline" (click)="viewDetails(guide.guide_id)">
                  Ver Detalles
                </button>
                <button 
                  *ngIf="guide.pdf_url" 
                  class="btn btn-outline"
                  (click)="downloadGuidePDF(guide.guide_id)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  PDF
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div *ngIf="!isLoadingGuides && guides.length > 0" class="pagination">
            <button 
              class="btn btn-outline" 
              (click)="previousPage()" 
              [disabled]="currentPage === 0">
              Anterior
            </button>
            <span class="pagination-info">
              Página {{ currentPage + 1 }} de {{ getTotalPages() }}
            </span>
            <button 
              class="btn btn-outline" 
              (click)="nextPage()" 
              [disabled]="currentPage >= getTotalPages() - 1">
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Tab -->
    <div class="tab-content" *ngIf="activeTab === 'search'">
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            Buscar y Rastrear Envíos
          </h2>
          <p class="card-description">Busca guías por número, cliente o ciudad</p>
        </div>
        <div class="card-content">
          <form (ngSubmit)="handleSearchTracking()" class="search-form">
            <input 
              type="text" 
              placeholder="Número de guía, nombre del cliente o ciudad..." 
              [(ngModel)]="trackingSearch"
              name="trackingSearch"
              class="search-input"
              [disabled]="isSearching">
            <button 
              type="submit" 
              class="btn btn-primary btn-large"
              [disabled]="isSearching || trackingSearch.length < 3">
              <svg *ngIf="!isSearching" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <svg *ngIf="isSearching" class="spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
              </svg>
              {{ isSearching ? 'Buscando...' : 'Buscar' }}
            </button>
          </form>
        </div>
      </div>

      <div class="card" *ngIf="searchResults.length > 0">
        <div class="card-header">
          <h2 class="card-title">Resultados de Búsqueda</h2>
          <p class="card-description">{{ searchResults.length }} resultado(s) encontrado(s)</p>
        </div>
        <div class="card-content">
          <div *ngFor="let guide of searchResults" class="search-result">
            <div class="result-header">
              <div class="result-id">Guía #{{ guide.guide_id }}</div>
              <span class="badge" [ngClass]="getStatusBadgeClass(guide.current_status)">
                {{ translateStatus(guide.current_status) }}
              </span>
            </div>
            <div class="result-details">
              <div><strong>Remitente:</strong> {{ guide.sender?.full_name || 'N/A' }}</div>
              <div><strong>Destinatario:</strong> {{ guide.receiver?.full_name || 'N/A' }}</div>
              <div><strong>Origen:</strong> {{ guide.origin_city_name }}</div>
              <div><strong>Destino:</strong> {{ guide.destination_city_name }}</div>
              <div><strong>Creada:</strong> {{ formatDate(guide.created_at) }}</div>
            </div>
            <div class="result-history" *ngIf="guide.history && guide.history.length > 0">
              <div class="history-title">Historial de estados:</div>
              <div class="history-items">
                <div *ngFor="let item of guide.history" class="history-item">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  {{ translateStatus(item.status) }} - {{ formatDate(item.updated_at) }}
                </div>
              </div>
            </div>
            <div class="result-actions">
              <button class="btn btn-outline" (click)="viewDetails(guide.guide_id)">
                Ver Detalles Completos
              </button>
              <button 
                *ngIf="guide.pdf_url" 
                class="btn btn-primary"
                (click)="downloadGuidePDF(guide.guide_id)">
                Descargar PDF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" *ngIf="activeTab === 'reports'">
      <!-- Loading State -->
      <div *ngIf="isLoadingStats" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando estadísticas...</p>
      </div>

      <div *ngIf="!isLoadingStats && stats">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              <h3>Guías Hoy</h3>
            </div>
            <div class="stat-value primary">{{ stats.total_today }}</div>
            <div class="stat-label">Creadas el día de hoy</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <h3>Procesadas</h3>
            </div>
            <div class="stat-value success">{{ stats.total_processed }}</div>
            <div class="stat-label">Entregadas exitosamente</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <h3>Pendientes</h3>
            </div>
            <div class="stat-value warning">{{ stats.total_pending }}</div>
            <div class="stat-label">Requieren atención</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Distribución por Estado</h2>
            <p class="card-description">Cantidad de guías en cada estado</p>
          </div>
          <div class="card-content">
            <div class="status-distribution">
              <div *ngFor="let status of availableStatuses" class="status-stat-item">
                <div class="status-stat-header">
                  <span class="badge" [ngClass]="getStatusBadgeClass(status.value)">
                    {{ status.label }}
                  </span>
                  <span class="status-stat-count">
                    {{ stats.by_status[status.value] || 0 }}
                  </span>
                </div>
                <div class="status-stat-bar">
                  <div 
                    class="status-stat-fill" 
                    [ngClass]="getStatusBadgeClass(status.value)"
                    [style.width.%]="calculatePercentage(stats.by_status[status.value] || 0)">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Cash Close Tab -->
    <div class="tab-content" *ngIf="activeTab === 'cash-close'">
      <!-- Estadísticas de Cierres -->
      <div *ngIf="!isLoadingCloseStats && cashCloseStats" class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <h3>Hoy</h3>
          </div>
          <div class="stat-value primary">${{ cashCloseStats.today_total.toLocaleString() }}</div>
          <div class="stat-label">Total cierres del día</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h3>Este Mes</h3>
          </div>
          <div class="stat-value success">${{ cashCloseStats.month_total.toLocaleString() }}</div>
          <div class="stat-label">Total del mes actual</div>
        </div>

        <div class="stat-card">
          <div class="stat-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h3>Este Año</h3>
          </div>
          <div class="stat-value warning">${{ cashCloseStats.year_total.toLocaleString() }}</div>
          <div class="stat-label">Total del año actual</div>
        </div>
      </div>

      <!-- Formulario para Generar Cierre - REEMPLAZAR toda la sección del formulario -->
      <div class="card mb-6">
        <div class="card-header">
          <h2 class="card-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="5" width="20" height="14" rx="2"></rect>
              <line x1="2" y1="10" x2="22" y2="10"></line>
            </svg>
            Generar Nuevo Cierre de Caja
          </h2>
          <p class="card-description">Selecciona el tipo de período y las fechas para generar un cierre</p>
        </div>
        <div class="card-content">
          <div class="cash-close-form">
            <div class="form-row">
              <!-- Tipo de Período -->
              <div class="form-field">
                <label for="periodType">Tipo de Período *</label>
                <select id="periodType" [(ngModel)]="selectedPeriodType">
                  <option value="DAILY">Diario</option>
                  <option value="WEEKLY">Semanal</option>
                  <option value="MONTHLY">Mensual</option>
                  <option value="YEARLY">Anual</option>
                </select>
              </div>

              <!-- Año - Aparece SIEMPRE -->
              <div class="form-field">
                <label for="closeYear">Año *</label>
                <select id="closeYear" [(ngModel)]="selectedYear">
                  <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                </select>
              </div>

              <!-- Mes - Aparece para MONTHLY, WEEKLY y DAILY -->
              <div class="form-field" *ngIf="selectedPeriodType === 'MONTHLY' || selectedPeriodType === 'WEEKLY' || selectedPeriodType === 'DAILY'">
                <label for="closeMonth">Mes *</label>
                <select id="closeMonth" [(ngModel)]="selectedMonth">
                  <option *ngFor="let month of months" [value]="month.value">{{ month.label }}</option>
                </select>
              </div>

              <!-- Día - Aparece SOLO para DAILY y WEEKLY -->
              <div class="form-field" *ngIf="selectedPeriodType === 'DAILY' || selectedPeriodType === 'WEEKLY'">
                <label for="closeDay">{{ selectedPeriodType === 'WEEKLY' ? 'Día de inicio *' : 'Día *' }}</label>
                <select id="closeDay" [(ngModel)]="selectedDay">
                  <option *ngFor="let day of days" [value]="day">{{ day }}</option>
                </select>
              </div>
            </div>

            <!-- Info del período -->
            <div class="period-info" *ngIf="selectedPeriodType">
              <div class="info-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </div>
              <div class="info-text">
                <span *ngIf="selectedPeriodType === 'DAILY'">
                  Se generará un cierre para el día <strong>{{ selectedDay }}/{{ selectedMonth }}/{{ selectedYear }}</strong>
                </span>
                <span *ngIf="selectedPeriodType === 'WEEKLY'">
                  Se generará un cierre semanal comenzando el <strong>{{ selectedDay }}/{{ selectedMonth }}/{{ selectedYear }}</strong> (7 días consecutivos)
                </span>
                <span *ngIf="selectedPeriodType === 'MONTHLY'">
                  Se generará un cierre para todo el mes de <strong>{{ months[selectedMonth - 1]?.label }} {{ selectedYear }}</strong>
                </span>
                <span *ngIf="selectedPeriodType === 'YEARLY'">
                  Se generará un cierre para todo el año <strong>{{ selectedYear }}</strong>
                </span>
              </div>
            </div>

            <button 
              class="btn btn-primary btn-large" 
              (click)="handleGenerateCashClose()"
              [disabled]="isGeneratingClose">
              <svg *ngIf="isGeneratingClose" class="spinner" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
              </svg>
              <svg *ngIf="!isGeneratingClose" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              {{ isGeneratingClose ? 'Generando cierre...' : 'Generar Cierre de Caja' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Lista de Cierres -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Historial de Cierres de Caja</h2>
          <p class="card-description">
            Mostrando {{ cashCloses.length }} de {{ totalCloses }} cierres
          </p>
        </div>
        <div class="card-content">
          <!-- Loading State -->
          <div *ngIf="isLoadingCloses" class="loading-container">
            <div class="spinner"></div>
            <p>Cargando cierres...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoadingCloses && cashCloses.length === 0" class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="5" width="20" height="14" rx="2"></rect>
              <line x1="2" y1="10" x2="22" y2="10"></line>
            </svg>
            <h3>No hay cierres de caja</h3>
            <p>Aún no se han generado cierres de caja. Usa el formulario de arriba para crear uno.</p>
          </div>

          <!-- Closes List -->
          <div *ngIf="!isLoadingCloses && cashCloses.length > 0" class="closes-list">
            <div *ngFor="let close of cashCloses" class="close-item">
              <div class="close-header">
                <div class="close-id-section">
                  <div class="close-id">Cierre #{{ close.close_id }}</div>
                  <div class="close-period">
                    <span class="badge badge-secondary">{{ translatePeriodType(close.period_type) }}</span>
                    <span class="close-date">{{ formatCloseDate(close.start_date) }} - {{ formatCloseDate(close.end_date) }}</span>
                  </div>
                </div>
                <div class="close-total">
                  <div class="total-label">Total</div>
                  <div class="total-amount">${{ close.total_amount.toLocaleString() }}</div>
                </div>
              </div>

              <div class="close-summary">
                <div class="summary-grid">
                  <div class="summary-item">
                    <div class="summary-icon cash">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                      </svg>
                    </div>
                    <div class="summary-info">
                      <div class="summary-label">Contado</div>
                      <div class="summary-value">${{ close.total_cash.toLocaleString() }}</div>
                    </div>
                  </div>

                  <div class="summary-item">
                    <div class="summary-icon cod">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                      <polyline points="3.29 7 12 12 20.71 7"></polyline>
                      <line x1="12" y1="22" x2="12" y2="12"></line>
                    </svg>
                    </div>
                    <div class="summary-info">
                      <div class="summary-label">Contraentrega</div>
                      <div class="summary-value">${{ close.total_cod.toLocaleString() }}</div>
                    </div>
                  </div>

                  <div class="summary-item">
                    <div class="summary-icon credit">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                      </svg>
                    </div>
                    <div class="summary-info">
                      <div class="summary-label">Crédito</div>
                      <div class="summary-value">${{ close.total_credit.toLocaleString() }}</div>
                    </div>
                  </div>

                  <div class="summary-item">
                    <div class="summary-icon guides">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                    </div>
                    <div class="summary-info">
                      <div class="summary-label">Guías</div>
                      <div class="summary-value">{{ close.total_guides }}</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="close-details">
                <div class="detail-row">
                  <span class="detail-label">Unidades:</span>
                  <span class="detail-value">{{ close.total_units }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Peso total:</span>
                  <span class="detail-value">{{ close.total_weight.toFixed(2) }} kg</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Fletes:</span>
                  <span class="detail-value">${{ close.total_freight.toLocaleString() }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Acarreo:</span>
                  <span class="detail-value">${{ close.total_handling.toLocaleString() }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Otros:</span>
                  <span class="detail-value">${{ close.total_other.toLocaleString() }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Descuentos:</span>
                  <span class="detail-value">${{ close.total_discounts.toLocaleString() }}</span>
                </div>
              </div>

              <div class="close-footer">
                <div class="close-metadata">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                  <span>Creado: {{ formatDate(close.created_at) }}</span>
                </div>
                <button 
                  *ngIf="close.pdf_url || close.pdf_s3_key" 
                  class="btn btn-primary"
                  (click)="downloadClosePDF(close.close_id)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Descargar PDF
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div *ngIf="!isLoadingCloses && cashCloses.length > 0" class="pagination">
            <button 
              class="btn btn-outline" 
              (click)="previousClosePage()" 
              [disabled]="currentClosePage === 0">
              Anterior
            </button>
            <span class="pagination-info">
              Página {{ currentClosePage + 1 }} de {{ getTotalClosePages() }}
            </span>
            <button 
              class="btn btn-outline" 
              (click)="nextClosePage()" 
              [disabled]="currentClosePage >= getTotalClosePages() - 1">
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <app-guide-details-modal
    [guide]="selectedGuideForDetails"
    [isOpen]="isDetailsModalOpen"
    (closeModal)="closeDetailsModal()"
    (downloadPDFEvent)="downloadPDFFromModal($event)">
  </app-guide-details-modal>
</div>
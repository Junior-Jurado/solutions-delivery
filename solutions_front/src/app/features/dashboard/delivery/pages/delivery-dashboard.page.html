<div class="delivery-container">
  <!-- ========================================
       HEADER
       ======================================== -->
  <app-dashboard-header
    userRole="Repartidor"
    userDescription="Panel de entregas"
    [userName]="userName"
    [showUserName]="true"
    [isMobile]="isMobile"
    (logout)="logout()">
  </app-dashboard-header>

  <!-- ========================================
       MAIN PANEL
       ======================================== -->
  <div class="delivery-panel">
    <!-- Tabs Navigation -->
    <nav class="tabs-navigation">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'deliveries'"
      (click)="setActiveTab('deliveries')">
      <app-icon category="common" name="package" size="20px"></app-icon>
      <span>Mis Entregas</span>
    </button>

    <button 
      class="tab-button" 
      [class.active]="activeTab === 'confirm'"
      (click)="setActiveTab('confirm')">
      <app-icon category="common" name="check-circle" size="20px"></app-icon>
      <span>Confirmar Entrega</span>
    </button>

    <button 
      class="tab-button" 
      [class.active]="activeTab === 'issues'"
      (click)="setActiveTab('issues')">
      <app-icon category="common" name="alert-triangle" size="20px"></app-icon>
      <span>Reportar Problema</span>
    </button>

    <button 
      class="tab-button" 
      [class.active]="activeTab === 'performance'"
      (click)="setActiveTab('performance')">
      <app-icon category="common" name="star" size="20px"></app-icon>
      <span>Mi Rendimiento</span>
    </button>
  </nav>

  <!-- ========================================
       TAB 1: DELIVERIES
       ======================================== -->
  <div class="tab-content" *ngIf="activeTab === 'deliveries'">
    <div class="content-wrapper">
      <!-- Stats Cards -->
      <div class="stats-grid" *ngIf="stats">
        <div class="stat-card">
          <div class="stat-label">Entregas Hoy</div>
          <div class="stat-value primary">{{ stats.total_today }}</div>
          <div class="stat-detail">{{ stats.pending }} pendientes</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Completadas</div>
          <div class="stat-value success">{{ stats.completed }}</div>
          <div class="stat-detail success">{{ ((stats.completed / stats.total_today) * 100).toFixed(0) }}% completado</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Tiempo Promedio</div>
          <div class="stat-value warning">{{ stats.avg_time_minutes }}min</div>
          <div class="stat-detail">Por entrega</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Calificación</div>
          <div class="stat-value rating">{{ stats.rating }}⭐</div>
          <div class="stat-detail">Promedio cliente</div>
        </div>
      </div>

      <!-- Deliveries List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Entregas Asignadas</h2>
          <p class="card-description">Paquetes para entregar hoy</p>
        </div>

        <div class="card-content">
          <!-- Loading -->
          <div *ngIf="isLoadingDeliveries" class="loading-state">
            <app-icon category="common" name="loader" size="48px" customClass="spinner"></app-icon>
            <p>Cargando entregas...</p>
          </div>

          <!-- Empty State -->
          <div *ngIf="!isLoadingDeliveries && deliveries.length === 0" class="empty-state">
            <app-icon category="common" name="package" size="64px"></app-icon>
            <p>No hay entregas asignadas en este momento</p>
          </div>

          <!-- Deliveries -->
          <div class="deliveries-list" *ngIf="!isLoadingDeliveries && deliveries.length > 0">
            <div *ngFor="let delivery of deliveries" class="delivery-card">
              <!-- Header -->
              <div class="delivery-header">
                <div class="delivery-info">
                  <div class="delivery-id">{{ delivery.guide_number }}</div>
                  <div class="delivery-time">
                    <app-icon category="common" name="clock" size="16px"></app-icon>
                    <span>Estimado: {{ delivery.estimated_time }}</span>
                  </div>
                </div>
                <div class="delivery-badges">
                  <span class="badge" [ngClass]="getPriorityBadgeClass(delivery.priority)">
                    {{ delivery.priority }}
                  </span>
                  <span class="badge" [ngClass]="getStatusBadgeClass(delivery.status)">
                    {{ delivery.status === 'PENDING' ? 'Pendiente' : delivery.status === 'IN_ROUTE' ? 'En ruta' : 'Entregada' }}
                  </span>
                </div>
              </div>

              <!-- Details Grid -->
              <div class="delivery-details">
                <div class="detail-section">
                  <div class="detail-label">
                    <app-icon category="common" name="map-pin" size="16px"></app-icon>
                    Destinatario:
                  </div>
                  <div class="detail-value">{{ delivery.recipient }}</div>
                  <div class="detail-value muted">{{ delivery.address }}</div>
                </div>

                <div class="detail-section">
                  <div class="detail-label">
                    <app-icon category="common" name="phone" size="16px"></app-icon>
                    Contacto:
                  </div>
                  <div class="detail-value">{{ delivery.phone }}</div>
                  <div class="detail-value">Valor: ${{ formatPrice(delivery.value) }}</div>
                </div>
              </div>

              <!-- Instructions -->
              <div class="delivery-instructions" *ngIf="delivery.instructions">
                <div class="instructions-label">Instrucciones especiales:</div>
                <div class="instructions-text">{{ delivery.instructions }}</div>
              </div>

              <!-- Actions -->
              <div class="delivery-actions">
                <button class="btn btn-outline" (click)="viewOnMap(delivery)">
                  <app-icon category="common" name="navigation" size="16px"></app-icon>
                  <span>Ver Mapa</span>
                </button>

                <button class="btn btn-outline" (click)="callRecipient(delivery)">
                  <app-icon category="common" name="phone" size="16px"></app-icon>
                  <span>Llamar</span>
                </button>

                <button 
                  class="btn"
                  [ngClass]="delivery.status === 'IN_ROUTE' ? 'btn-primary' : 'btn-secondary'"
                  (click)="delivery.status === 'IN_ROUTE' ? goToConfirmTab(delivery) : startRoute(delivery)">
                  <span>{{ delivery.status === 'IN_ROUTE' ? 'Confirmar Entrega' : 'Iniciar Ruta' }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================
       TAB 2: CONFIRM DELIVERY
       ======================================== -->
  <div class="tab-content" *ngIf="activeTab === 'confirm'">
    <div class="content-wrapper">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <app-icon category="common" name="check-circle" size="24px"></app-icon>
            Confirmar Entrega
          </h2>
          <p class="card-description">
            Confirma la entrega usando el código OTP y sube la imagen de entrega
          </p>
        </div>

        <div class="card-content">
          <form (ngSubmit)="confirmDelivery()" class="confirm-form">
            <!-- Select Guide -->
            <div class="form-field">
              <label for="guide-select">Seleccionar guía a confirmar *</label>
              <select 
                id="guide-select"
                [(ngModel)]="selectedDelivery"
                name="selectedDelivery"
                class="form-select"
                required>
                <option value="">Seleccionar...</option>
                <option *ngFor="let delivery of deliveriesInRoute" [value]="delivery.id">
                  {{ delivery.guide_number }} - {{ delivery.recipient }}
                </option>
              </select>
            </div>

            <!-- Selected Delivery Info -->
            <div class="info-banner" *ngIf="selectedDeliveryData">
              <div class="info-title">Información de la entrega:</div>
              <div class="info-details">
                <div>Destinatario: {{ selectedDeliveryData.recipient }}</div>
                <div>Dirección: {{ selectedDeliveryData.address }}</div>
                <div>Valor: ${{ formatPrice(selectedDeliveryData.value) }}</div>
              </div>
            </div>

            <div class="form-grid">
              <!-- Left Column -->
              <div class="form-column">
                <!-- OTP Code -->
                <div class="form-field">
                  <label for="otp">Código OTP del cliente *</label>
                  <input 
                    id="otp"
                    type="text"
                    [(ngModel)]="otpCode"
                    name="otpCode"
                    placeholder="123456"
                    maxlength="6"
                    class="form-input"
                    required>
                  <div class="field-hint">
                    El cliente debe proporcionarte este código de 6 dígitos
                  </div>
                </div>

                <!-- Delivery Notes -->
                <div class="form-field">
                  <label for="delivery-notes">Notas de entrega</label>
                  <textarea 
                    id="delivery-notes"
                    [(ngModel)]="deliveryNotes"
                    name="deliveryNotes"
                    placeholder="Entregado en perfectas condiciones..."
                    class="form-textarea"></textarea>
                </div>

                <!-- Package Condition -->
                <div class="form-field">
                  <label for="package-condition">Estado del paquete</label>
                  <select 
                    id="package-condition"
                    [(ngModel)]="packageCondition"
                    name="packageCondition"
                    class="form-select">
                    <option value="perfect">Perfecto estado</option>
                    <option value="minor-damage">Daño menor</option>
                    <option value="damaged">Dañado</option>
                  </select>
                </div>
              </div>

              <!-- Right Column -->
              <div class="form-column">
                <!-- Delivery Photo -->
                <div class="form-field">
                  <label>Imagen de entrega *</label>
                  <div class="upload-area">
                    <app-icon category="common" name="camera" size="48px"></app-icon>
                    <p>Toma una foto de la entrega</p>
                    <div class="upload-buttons">
                      <button type="button" class="btn btn-outline" (click)="openCamera()">
                        <app-icon category="common" name="camera" size="16px"></app-icon>
                        Abrir Cámara
                      </button>
                      <input 
                        type="file" 
                        accept="image/*" 
                        (change)="onDeliveryPhotoChange($event)"
                        style="display: none;"
                        #photoInput>
                      <button type="button" class="btn btn-ghost" (click)="photoInput.click()">
                        <app-icon category="common" name="upload" size="16px"></app-icon>
                        Subir desde Galería
                      </button>
                    </div>
                    <div *ngIf="deliveryPhotoBase64" class="upload-preview">
                      <img [src]="deliveryPhotoBase64" alt="Preview">
                    </div>
                  </div>
                </div>

                <!-- Signature -->
                <div class="form-field">
                  <label>Firma del destinatario</label>
                  <div class="signature-area">
                    <app-icon category="common" name="file-text" size="32px"></app-icon>
                    <p>Área de firma digital</p>
                    <button type="button" class="btn btn-outline btn-sm">
                      Activar Firma
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <button 
              type="submit" 
              class="btn btn-primary btn-large btn-full"
              [disabled]="isConfirming || !selectedDelivery || !otpCode || !deliveryPhotoBase64">
              <app-icon 
                *ngIf="isConfirming"
                category="common" 
                name="loader" 
                size="20px"
                customClass="spinner">
              </app-icon>
              <app-icon 
                *ngIf="!isConfirming"
                category="common" 
                name="check-circle" 
                size="20px">
              </app-icon>
              <span>{{ isConfirming ? 'Confirmando...' : 'Confirmar Entrega Exitosa' }}</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================
       TAB 3: REPORT ISSUE
       ======================================== -->
  <div class="tab-content" *ngIf="activeTab === 'issues'">
    <div class="content-wrapper">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">
            <app-icon category="common" name="alert-triangle" size="24px"></app-icon>
            Reportar Problema en Entrega
          </h2>
          <p class="card-description">
            Reporta cualquier inconveniente durante la entrega
          </p>
        </div>

        <div class="card-content">
          <form (ngSubmit)="reportIssue()" class="issue-form">
            <!-- Guide Select -->
            <div class="form-field">
              <label for="problem-guide">Número de guía *</label>
              <select 
                id="problem-guide"
                [(ngModel)]="selectedIssueGuide"
                name="selectedIssueGuide"
                class="form-select"
                required>
                <option value="">Seleccionar guía...</option>
                <option *ngFor="let delivery of deliveries" [value]="delivery.id">
                  {{ delivery.guide_number }} - {{ delivery.recipient }}
                </option>
              </select>
            </div>

            <!-- Issue Type -->
            <div class="form-field">
              <label for="issue-type">Tipo de problema *</label>
              <select 
                id="issue-type"
                [(ngModel)]="issueType"
                name="issueType"
                class="form-select"
                required>
                <option value="">Seleccionar...</option>
                <option value="address-incorrect">Dirección incorrecta</option>
                <option value="recipient-unavailable">Destinatario no disponible</option>
                <option value="access-denied">Acceso denegado al edificio</option>
                <option value="package-damaged">Paquete dañado</option>
                <option value="payment-issue">Problema con el pago</option>
                <option value="other">Otro</option>
              </select>
            </div>

            <!-- Description -->
            <div class="form-field">
              <label for="issue-description">Descripción del problema *</label>
              <textarea 
                id="issue-description"
                [(ngModel)]="issueDescription"
                name="issueDescription"
                placeholder="Describe detalladamente lo que ocurrió..."
                class="form-textarea"
                required></textarea>
            </div>

            <!-- Evidence Photos -->
            <div class="form-field">
              <label>Evidencia fotográfica</label>
              <div class="upload-area">
                <app-icon category="common" name="camera" size="32px"></app-icon>
                <p>Opcional: Sube fotos que sustenten el reporte</p>
                <input 
                  type="file" 
                  multiple 
                  accept="image/*" 
                  (change)="onIssuePhotoChange($event)"
                  style="display: none;"
                  #issuePhotoInput>
                <button type="button" class="btn btn-outline" (click)="issuePhotoInput.click()">
                  Agregar Fotos
                </button>
              </div>
            </div>

            <!-- Attempted Resolution -->
            <div class="form-field">
              <label for="attempted-resolution">¿Qué intentaste hacer para resolver el problema?</label>
              <textarea 
                id="attempted-resolution"
                [(ngModel)]="attemptedResolution"
                name="attemptedResolution"
                placeholder="Llamé al cliente, pregunté al portero, etc..."
                class="form-textarea"></textarea>
            </div>

            <!-- Submit Button -->
            <button 
              type="submit" 
              class="btn btn-danger btn-full"
              [disabled]="isReporting || !selectedIssueGuide || !issueType || !issueDescription">
              <app-icon 
                *ngIf="isReporting"
                category="common" 
                name="loader" 
                size="16px"
                customClass="spinner">
              </app-icon>
              <app-icon 
                *ngIf="!isReporting"
                category="common" 
                name="alert-triangle" 
                size="16px">
              </app-icon>
              <span>{{ isReporting ? 'Enviando...' : 'Enviar Reporte' }}</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================
       TAB 4: PERFORMANCE
       ======================================== -->
  <div class="tab-content" *ngIf="activeTab === 'performance'">
    <div class="content-wrapper">
      <!-- Performance Stats -->
      <div class="stats-grid" *ngIf="performanceStats">
        <div class="stat-card">
          <div class="stat-label">Entregas Esta Semana</div>
          <div class="stat-value primary">{{ performanceStats.deliveries_this_week }}</div>
          <div class="stat-detail success">+15% vs semana anterior</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Tasa de Éxito</div>
          <div class="stat-value success">{{ performanceStats.success_rate }}%</div>
          <div class="stat-detail success">Entregas exitosas</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Tiempo Promedio</div>
          <div class="stat-value warning">{{ performanceStats.avg_time_minutes }}min</div>
          <div class="stat-detail success">-5min vs semana anterior</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Calificación Promedio</div>
          <div class="stat-value rating">{{ performanceStats.avg_rating }}⭐</div>
          <div class="stat-detail success">+0.2 vs mes anterior</div>
        </div>
      </div>

      <div class="performance-grid">
        <!-- Daily Performance -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Rendimiento Diario</h3>
            <p class="card-description">Entregas completadas por día</p>
          </div>
          <div class="card-content">
            <div class="performance-list" *ngIf="performanceStats">
              <div *ngFor="let day of performanceStats.daily_performance" class="performance-item">
                <div class="performance-day">{{ day.day }}</div>
                <div class="performance-stats">
                  <div class="performance-count">
                    <span class="value">{{ day.deliveries }}</span>
                    <span class="target">/{{ day.target }}</span>
                  </div>
                  <span class="badge" [ngClass]="day.efficiency >= 100 ? 'badge-success' : 'badge-secondary'">
                    {{ day.efficiency }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Customer Reviews -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Comentarios de Clientes</h3>
            <p class="card-description">Últimas calificaciones recibidas</p>
          </div>
          <div class="card-content">
            <div class="reviews-list" *ngIf="performanceStats">
              <div *ngFor="let review of performanceStats.recent_reviews" class="review-item">
                <div class="review-header">
                  <div class="review-stars">
                    <span *ngFor="let filled of getStarArray(review.rating)" class="star" [class.filled]="filled">
                      ⭐
                    </span>
                  </div>
                  <div class="review-date">{{ review.date }}</div>
                </div>
                <div class="review-comment">"{{ review.comment }}"</div>
                <div class="review-client">- {{ review.client }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-overlay" *ngIf="isOpen" (click)="onOverlayClick()">
  <div class="modal-content preview-modal" (click)="$event.stopPropagation()">
    <!-- HEADER -->
    <div class="modal-header">
      <h2>{{ title }}</h2>
      <button class="btn-close" (click)="onCancel()" [disabled]="isCreating">
        <app-icon category="navigation" name="x" size="24px"></app-icon>
      </button>
    </div>

    <!-- BODY -->
    <div class="modal-body" *ngIf="guideData">
      <!-- Warning Banner -->
      <div class="warning-banner">
        <app-icon category="status" name="alert-triangle" size="24px"></app-icon>
        <p><strong>Importante:</strong> {{ warningMessage }}</p>
      </div>

      <!-- Price Banner -->
      <div class="price-banner" [class.editable]="allowPriceEdit" [class.editing]="isEditingPrice">
        <div class="price-header">
          <div class="price-label">
            <app-icon category="finance" name="dollar-sign" size="24px"></app-icon>
            <span>Precio del Envío</span>
          </div>
          <button
            *ngIf="allowPriceEdit && !isEditingPrice && !isCreating"
            class="btn-edit-price"
            (click)="startEditPrice()"
            title="Modificar precio">
            <app-icon category="actions" name="edit" size="16px"></app-icon>
            <span>Modificar</span>
          </button>
        </div>

        <!-- Modo visualización -->
        <ng-container *ngIf="!isEditingPrice">
          <div class="price-amount" [class.modified]="customPrice > 0">
            ${{ formatPrice(currentPrice) }}
          </div>
          <div class="price-details">
            <span>Peso: {{ guideData.weight }} kg | Tipo: {{ guideData.serviceType }}</span>
            <span *ngIf="isPriceModified" class="price-modified-badge">
              <app-icon category="actions" name="edit" size="12px"></app-icon>
              Precio modificado{{ priceChangeReason ? ': ' + priceChangeReason : '' }}
              <button class="btn-reset-price" (click)="resetToCalculatedPrice()" title="Restaurar precio calculado">
                <app-icon category="navigation" name="x" size="12px"></app-icon>
              </button>
            </span>
          </div>
          <div *ngIf="isPriceModified" class="original-price">
            Precio calculado: ${{ formatPrice(guideData.calculatedPrice) }}
          </div>
        </ng-container>

        <!-- Modo edición -->
        <div *ngIf="isEditingPrice" class="price-edit-form">
          <div class="price-input-group">
            <span class="currency-symbol">$</span>
            <input
              type="number"
              [(ngModel)]="customPrice"
              class="price-input"
              min="0"
              step="1000"
              placeholder="Ingrese el precio">
          </div>
          <div class="price-reason-group">
            <label class="reason-label">Razón del cambio de precio *</label>
            <input
              type="text"
              [(ngModel)]="priceChangeReason"
              class="reason-input"
              placeholder="Ej: Descuento cliente frecuente"
              maxlength="200">
          </div>
          <div class="price-edit-actions">
            <button class="btn-save-price" (click)="savePrice()" [disabled]="!priceChangeReason.trim()">
              <app-icon category="status" name="check" size="16px"></app-icon>
              Aplicar
            </button>
            <button class="btn-cancel-price" (click)="cancelEditPrice()">
              <app-icon category="navigation" name="x" size="16px"></app-icon>
              Cancelar
            </button>
          </div>
          <div *ngIf="priceValidationError" class="price-validation-error">
            {{ priceValidationError }}
          </div>
          <div class="price-hint">
            Precio calculado automáticamente: ${{ formatPrice(guideData.calculatedPrice) }}
          </div>
        </div>
      </div>

      <!-- Preview Content -->
      <div class="preview-content">
        <!-- Remitente -->
        <div class="preview-section">
          <h3>
            <app-icon category="users" name="user-circle" size="20px"></app-icon>
            Remitente
          </h3>
          <div class="preview-details">
            <div class="preview-row">
              <span class="label">Nombre:</span>
              <span class="value">{{ guideData.senderName }}</span>
            </div>
            <div class="preview-row" *ngIf="guideData.senderDoc">
              <span class="label">Documento:</span>
              <span class="value">{{ guideData.senderDoc }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Ciudad:</span>
              <span class="value">{{ guideData.senderCity }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Dirección:</span>
              <span class="value">{{ guideData.senderAddress }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Teléfono:</span>
              <span class="value">{{ guideData.senderPhone }}</span>
            </div>
          </div>
        </div>

        <!-- Destinatario -->
        <div class="preview-section">
          <h3>
            <app-icon category="delivery" name="map-pin" size="20px"></app-icon>
            Destinatario
          </h3>
          <div class="preview-details">
            <div class="preview-row">
              <span class="label">Nombre:</span>
              <span class="value">{{ guideData.receiverName }}</span>
            </div>
            <div class="preview-row" *ngIf="guideData.receiverDoc">
              <span class="label">Documento:</span>
              <span class="value">{{ guideData.receiverDoc }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Ciudad:</span>
              <span class="value">{{ guideData.receiverCity }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Dirección:</span>
              <span class="value">{{ guideData.receiverAddress }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Teléfono:</span>
              <span class="value">{{ guideData.receiverPhone }}</span>
            </div>
          </div>
        </div>

        <!-- Paquete -->
        <div class="preview-section">
          <h3>
            <app-icon category="delivery" name="box" size="20px"></app-icon>
            Información del Paquete
          </h3>
          <div class="preview-details">
            <div class="preview-row">
              <span class="label">Peso:</span>
              <span class="value">{{ guideData.weight }} kg</span>
            </div>
            <div class="preview-row">
              <span class="label">Valor Declarado:</span>
              <span class="value">\${{ formatPrice(guideData.declaredValue) }}</span>
            </div>
            <div class="preview-row">
              <span class="label">Tipo de Servicio:</span>
              <span class="value">{{ guideData.serviceType }}</span>
            </div>
            <div class="preview-row" *ngIf="guideData.pieces && guideData.pieces > 1">
              <span class="label">Piezas:</span>
              <span class="value">{{ guideData.pieces }}</span>
            </div>
            <div class="preview-row" *ngIf="guideData.dimensions">
              <span class="label">Dimensiones:</span>
              <span class="value">{{ guideData.dimensions }} cm</span>
            </div>
            <div class="preview-row" *ngIf="guideData.content">
              <span class="label">Contenido:</span>
              <span class="value">{{ guideData.content }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="modal-footer">
      <button 
        class="btn btn-secondary" 
        (click)="onCancel()" 
        [disabled]="isCreating">
        <span>{{ cancelButtonText }}</span>
      </button>
      <button 
        class="btn btn-primary" 
        (click)="onConfirm()" 
        [disabled]="isCreating">
        <app-icon
          *ngIf="isCreating"
          category="status"
          name="loader" 
          size="20px"
          customClass="spinner">
        </app-icon>
        <app-icon
          *ngIf="!isCreating"
          category="status"
          name="check-circle" 
          size="20px">
        </app-icon>
        <span>{{ isCreating ? 'Creando...' : confirmButtonText }}</span>
      </button>
    </div>
  </div>
</div>